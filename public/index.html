<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arb Bot â€” Live Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, system-ui, 'SF Pro', sans-serif; background: #0a0a0f; color: #e0e0e8; }
        
        .header { 
            background: linear-gradient(135deg, #12121a 0%, #1a1a2e 100%);
            padding: 16px 24px; border-bottom: 1px solid #2a2a3a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.2rem; color: #7c8aff; }
        .header .controls { display: flex; gap: 8px; align-items: center; }
        .status { font-size: 0.75rem; }
        .status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .dot.green { background: #4ade80; }
        .dot.red { background: #f87171; }
        .dot.yellow { background: #facc15; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; max-width: 1400px; margin: 0 auto; padding-bottom: 60px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card {
            background: #12121a; border: 1px solid #2a2a3a; border-radius: 10px;
            padding: 16px; overflow: hidden;
        }
        .card.full { grid-column: 1 / -1; }
        .card h2 { font-size: 0.85rem; color: #8888aa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        .stat { text-align: center; padding: 8px; background: #0d0d14; border-radius: 8px; }
        .stat .value { font-size: 1.4rem; font-weight: 700; color: #fff; }
        .stat .value.green { color: #4ade80; }
        .stat .value.red { color: #f87171; }
        .stat .value.yellow { color: #facc15; }
        .stat .label { font-size: 0.7rem; color: #6b6b88; margin-top: 2px; }
        
        .scrollable { max-height: 380px; overflow-y: auto; }
        
        /* Opportunities */
        .opp-row {
            display: grid; grid-template-columns: 2fr 80px 80px 80px 70px;
            padding: 8px 0; border-bottom: 1px solid #1a1a2a; align-items: center;
            font-size: 0.8rem;
        }
        .opp-row.header { color: #6b6b88; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid #2a2a3a; }
        .opp-name { color: #c8c8e0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .spread { font-weight: 700; }
        .spread.positive { color: #4ade80; }
        .spread.negative { color: #f87171; }
        .spread.neutral { color: #facc15; }
        .source-tag { font-size: 0.6rem; color: #555; }
        .badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            text-align: center; font-weight: 600; display: inline-block;
        }
        .badge.arb { background: #1a3a2a; color: #4ade80; }
        .badge.watch { background: #2a2a1a; color: #facc15; }
        .badge.no { background: #2a1a1a; color: #f87171; }
        
        /* Trade Log */
        .trade-row {
            display: grid; grid-template-columns: 65px 70px 2fr 90px 90px 80px;
            padding: 7px 0; border-bottom: 1px solid #1a1a2a;
            font-size: 0.78rem; align-items: center;
        }
        .trade-row.header { color: #6b6b88; font-size: 0.7rem; text-transform: uppercase; }
        .trade-time { color: #555; font-size: 0.72rem; font-family: monospace; }
        .trade-type { font-weight: 700; font-size: 0.72rem; }
        .trade-type.entry { color: #60a5fa; }
        .trade-type.resolve { color: #a78bfa; }
        .trade-type.exit { color: #f97316; }
        .pnl.positive { color: #4ade80; font-weight: 600; }
        .pnl.negative { color: #f87171; font-weight: 600; }
        
        /* Positions */
        .pos-row {
            display: grid; grid-template-columns: 2fr 1fr 80px 80px 80px;
            padding: 7px 0; border-bottom: 1px solid #1a1a2a;
            font-size: 0.8rem; align-items: center;
        }
        .pos-row.header { color: #6b6b88; font-size: 0.7rem; text-transform: uppercase; }
        
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #12121a; border-top: 1px solid #2a2a3a;
            padding: 8px 24px; display: flex; justify-content: space-between;
            font-size: 0.72rem; color: #6b6b88;
        }
        
        button {
            background: #2a2a3a; color: #8888aa; border: 1px solid #3a3a4a;
            padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;
        }
        button:hover { background: #3a3a4a; color: #fff; }

        .fee-note { font-size: 0.7rem; color: #555; margin-top: 6px; font-style: italic; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¯ Arb Bot v2 â€” Multi-Strategy Dashboard</h1>
        <div class="controls">
            <div class="status">
                <span id="poly-status"><span class="dot green"></span>Poly</span>
                <span style="margin-left:6px;" id="kalshi-status"><span class="dot green"></span>Kalshi</span>
                <span style="margin-left:6px;" id="binance-status"><span class="dot yellow"></span>Coinbase</span>
            </div>
            <button onclick="resetPortfolio()" style="margin-left: 12px;">Reset</button>
        </div>
    </div>

    <div class="grid">
        <div class="card full">
            <h2>ðŸ“Š Portfolio â€” $500 per side</h2>
            <div class="stats">
                <div class="stat">
                    <div class="value" id="total-value">$1,000</div>
                    <div class="label">Total Value</div>
                </div>
                <div class="stat">
                    <div class="value green" id="net-pnl">$0.00</div>
                    <div class="label">Net P&L (after fees)</div>
                </div>
                <div class="stat">
                    <div class="value yellow" id="gross-pnl">$0.00</div>
                    <div class="label">Gross P&L</div>
                </div>
                <div class="stat">
                    <div class="value red" id="fees-paid">$0.00</div>
                    <div class="label">Fees Paid</div>
                </div>
                <div class="stat">
                    <div class="value" id="total-trades">0</div>
                    <div class="label">Trades</div>
                </div>
                <div class="stat">
                    <div class="value" id="win-rate">0%</div>
                    <div class="label">Win Rate</div>
                </div>
                <div class="stat">
                    <div class="value" id="open-positions">0</div>
                    <div class="label">Open Positions</div>
                </div>
                <div class="stat">
                    <div class="value" id="expected-profit">$0.00</div>
                    <div class="label">Expected (if held)</div>
                </div>
                <div class="stat">
                    <div class="value" id="poly-balance">$500</div>
                    <div class="label">Poly Balance</div>
                </div>
                <div class="stat">
                    <div class="value" id="kalshi-balance">$500</div>
                    <div class="label">Kalshi Balance</div>
                </div>
            </div>
            <div class="fee-note">3 strategies: Cross-Platform Arb (Polyâ†”Kalshi) â€¢ Crypto Speed (Coinbaseâ†’Poly 15min) â€¢ Same-Market Rebalancing (YES+NO&lt;$1)</div>
        </div>

        <div class="card full">
            <h2>âš¡ Crypto Speed â€” Real-Time Exchange Prices</h2>
            <div class="stats" id="crypto-prices">
                <div class="stat">
                    <div class="value" id="btc-price">â€”</div>
                    <div class="label">BTC</div>
                </div>
                <div class="stat">
                    <div class="value" id="btc-momentum">â€”</div>
                    <div class="label">BTC 2m Momentum</div>
                </div>
                <div class="stat">
                    <div class="value" id="eth-price">â€”</div>
                    <div class="label">ETH</div>
                </div>
                <div class="stat">
                    <div class="value" id="eth-momentum">â€”</div>
                    <div class="label">ETH 2m Momentum</div>
                </div>
                <div class="stat">
                    <div class="value" id="sol-price">â€”</div>
                    <div class="label">SOL</div>
                </div>
                <div class="stat">
                    <div class="value" id="sol-momentum">â€”</div>
                    <div class="label">SOL 2m Momentum</div>
                </div>
                <div class="stat">
                    <div class="value" id="cs-markets">0</div>
                    <div class="label">15m Markets</div>
                </div>
                <div class="stat">
                    <div class="value" id="cs-signals">0</div>
                    <div class="label">Signals Fired</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ðŸ”¥ Cross-Platform Opportunities</h2>
            <div class="scrollable">
                <div class="opp-row header" style="grid-template-columns: 2fr 60px 60px 60px 70px 55px;">
                    <span>Market</span>
                    <span>Gross</span>
                    <span>Fees</span>
                    <span>Net</span>
                    <span>Resolves</span>
                    <span>Signal</span>
                </div>
                <div id="opportunities">
                    <div style="padding: 20px; text-align: center; color: #6b6b88;">Scanning markets...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ðŸ“‚ Open Positions (Hold to Resolution)</h2>
            <div class="scrollable">
                <div class="pos-row header" style="grid-template-columns: 2fr 80px 70px 70px 100px;">
                    <span>Market</span>
                    <span>Sides</span>
                    <span>Cost</span>
                    <span>Net Profit</span>
                    <span>Pays Out</span>
                </div>
                <div id="positions">
                    <div style="padding: 20px; text-align: center; color: #6b6b88;">No positions â€” waiting for profitable spreads</div>
                </div>
            </div>
        </div>

        <div class="card full">
            <h2>ðŸ“‹ Trade History</h2>
            <div class="scrollable">
                <div class="trade-row header">
                    <span>Time</span>
                    <span>Type</span>
                    <span>Market</span>
                    <span>Cost</span>
                    <span>Fees</span>
                    <span>Net P&L</span>
                </div>
                <div id="trades">
                    <div style="padding: 20px; text-align: center; color: #6b6b88;">No trades yet â€” bot only enters when profitable after fees</div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <span>Paper Trading â€” Resolution Arb Strategy â€” Fees Included</span>
        <span id="last-update">Last update: â€”</span>
    </div>

    <script>
        let ws;

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}`);
            ws.onopen = () => {};
            ws.onclose = () => setTimeout(connect, 3000);
            ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
        }

        function handleMessage(msg) {
            document.getElementById('last-update').textContent = 'Last update: ' + new Date(msg.timestamp).toLocaleTimeString();
            if (msg.type === 'init' || msg.type === 'portfolio') updatePortfolio(msg.data.portfolio || msg.data);
            if (msg.type === 'init' || msg.type === 'opportunities') updateOpportunities(msg.data.opportunities || msg.data);
            if (msg.type === 'trade') fetch('/api/portfolio').then(r => r.json()).then(updatePortfolio);
        }

        function updatePortfolio(p) {
            if (!p) return;
            document.getElementById('total-value').textContent = '$' + p.totalValue;
            
            const netPnl = parseFloat(p.netPnL);
            const netEl = document.getElementById('net-pnl');
            netEl.textContent = (netPnl >= 0 ? '+$' : '-$') + Math.abs(netPnl).toFixed(2);
            netEl.className = 'value ' + (netPnl >= 0 ? 'green' : 'red');

            const grossPnl = parseFloat(p.grossPnL);
            const grossEl = document.getElementById('gross-pnl');
            grossEl.textContent = (grossPnl >= 0 ? '+$' : '-$') + Math.abs(grossPnl).toFixed(2);
            grossEl.className = 'value ' + (grossPnl >= 0 ? 'green' : 'red');

            document.getElementById('fees-paid').textContent = '$' + p.totalFeesPaid;
            document.getElementById('total-trades').textContent = p.totalTrades;
            document.getElementById('win-rate').textContent = p.winRate + '%';
            document.getElementById('open-positions').textContent = p.openPositions;
            document.getElementById('expected-profit').textContent = '+$' + (isNaN(parseFloat(p.expectedProfit)) ? '0.00' : p.expectedProfit);
            document.getElementById('poly-balance').textContent = '$' + p.polyBalance;
            document.getElementById('kalshi-balance').textContent = '$' + p.kalshiBalance;

            // Positions
            const posEl = document.getElementById('positions');
            if (p.positions?.length > 0) {
                posEl.innerHTML = p.positions.map(pos => {
                    let payoutStr = 'â€”';
                    if (pos.expiresAt) {
                        const exp = new Date(pos.expiresAt);
                        const now = new Date();
                        const diffMs = exp - now;
                        if (diffMs < 0) {
                            payoutStr = 'Expired';
                        } else if (diffMs < 3600000) {
                            payoutStr = Math.ceil(diffMs/60000) + 'm left';
                        } else if (diffMs < 86400000) {
                            payoutStr = Math.ceil(diffMs/3600000) + 'h left';
                        } else {
                            const days = Math.ceil(diffMs/86400000);
                            payoutStr = days + 'd â€” ' + exp.toLocaleDateString('en-US', {month:'short', day:'numeric'});
                        }
                    }
                    return `<div class="pos-row" style="grid-template-columns: 2fr 80px 70px 70px 100px;">
                        <span class="opp-name">${pos.name}</span>
                        <span>P:${pos.polySide} K:${pos.kalshiSide}</span>
                        <span>$${((pos.totalCost||0)/100).toFixed(2)}</span>
                        <span class="pnl positive">+$${((pos.expectedNetProfit||0)/100).toFixed(2)}</span>
                        <span style="color:#60a5fa;font-size:0.75rem;">${payoutStr}</span>
                    </div>`;
                }).join('');
            } else {
                posEl.innerHTML = '<div style="padding:20px;text-align:center;color:#6b6b88;">No positions â€” waiting for profitable spreads</div>';
            }

            // Trades
            if (p.recentTrades?.length > 0) {
                document.getElementById('trades').innerHTML = p.recentTrades.map(t => {
                    const time = t.timestamp ? new Date(t.timestamp).toLocaleTimeString() : (t.entryTime ? new Date(t.entryTime).toLocaleTimeString() : 'â€”');
                    const isEntry = t.type === 'ENTRY';
                    const isResolve = t.type === 'RESOLVE';
                    const typeClass = isEntry ? 'entry' : isResolve ? 'resolve' : 'exit';
                    const typeLabel = isEntry ? 'BUY' : isResolve ? 'RESOLVE' : 'EXIT';
                    const cost = isEntry ? '$' + ((t.totalCost||0)/100).toFixed(2) : (t.payout ? '$' + (t.payout/100).toFixed(2) : 'â€”');
                    const fees = t.fees ? '$' + (t.fees/100).toFixed(2) : 'â€”';
                    const netPnl = t.netPnl ?? t.netPnl ?? null;
                    const pnlStr = netPnl !== null ? ((netPnl >= 0 ? '+$' : '-$') + Math.abs(netPnl/100).toFixed(2)) : 'â€”';
                    const pnlClass = netPnl > 0 ? 'positive' : netPnl < 0 ? 'negative' : '';
                    
                    return `<div class="trade-row">
                        <span class="trade-time">${time}</span>
                        <span class="trade-type ${typeClass}">${typeLabel}</span>
                        <span class="opp-name">${t.name}</span>
                        <span>${cost}</span>
                        <span>${fees}</span>
                        <span class="pnl ${pnlClass}">${isEntry ? 'holding' : pnlStr}</span>
                    </div>`;
                }).join('');
            }
        }

        function updateOpportunities(opps) {
            const el = document.getElementById('opportunities');
            if (!opps?.length) {
                el.innerHTML = '<div style="padding:20px;text-align:center;color:#6b6b88;">Scanning markets...</div>';
                return;
            }
            
            el.innerHTML = opps.slice(0, 25).map(o => {
                const gross = o.grossSpread ?? 0;
                const fees = o.fees ?? 0;
                const net = o.netProfit ?? (gross - fees);
                const signal = o.isProfitable ? 'arb' : (gross > 0 ? 'watch' : 'no');
                const netClass = net > 0 ? 'positive' : net < -2 ? 'negative' : 'neutral';
                
                let resolveStr = 'â€”';
                if (o.expiresAt) {
                    const exp = new Date(o.expiresAt);
                    const diffMs = exp - new Date();
                    if (diffMs < 3600000) resolveStr = Math.ceil(diffMs/60000) + 'm';
                    else if (diffMs < 86400000) resolveStr = Math.ceil(diffMs/3600000) + 'h';
                    else resolveStr = Math.ceil(diffMs/86400000) + 'd';
                }
                    
                return `<div class="opp-row" style="grid-template-columns: 2fr 60px 60px 60px 70px 55px;">
                    <span class="opp-name">${o.name || '?'}</span>
                    <span class="spread ${gross > 0 ? 'positive' : 'negative'}">${gross.toFixed(1)}Â¢</span>
                    <span style="color:#f87171;font-size:0.78rem;">-${fees.toFixed(1)}Â¢</span>
                    <span class="spread ${netClass}">${net.toFixed(1)}Â¢</span>
                    <span style="color:#60a5fa;font-size:0.72rem;">${resolveStr}</span>
                    <span><span class="badge ${signal}">${signal === 'arb' ? 'âœ… ARB' : signal === 'watch' ? 'ðŸ‘€' : 'âœ—'}</span></span>
                </div>`;
            }).join('');
        }

        async function resetPortfolio() {
            if (!confirm('Reset portfolio to $500/side?')) return;
            await fetch('/api/reset', { method: 'POST' });
            fetch('/api/portfolio').then(r => r.json()).then(updatePortfolio);
        }

        function updateCryptoSpeed(data) {
            if (!data?.binance) return;
            const snap = data.binance;
            
            const formatPrice = (ticker, price) => {
                if (!price) return 'â€”';
                if (ticker === 'SOL') return '$' + price.toFixed(2);
                if (ticker === 'ETH') return '$' + price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return '$' + price.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            };
            
            const formatMomentum = (m) => {
                if (!m || m.direction === 'flat') return { text: 'FLAT', cls: '' };
                const arrow = m.changePercent > 0 ? 'â†‘' : 'â†“';
                const pct = Math.abs(m.changePercent).toFixed(3);
                const cls = m.changePercent > 0.15 ? 'green' : m.changePercent < -0.15 ? 'red' : 'yellow';
                return { text: `${arrow} ${pct}%`, cls };
            };
            
            for (const ticker of ['BTC', 'ETH', 'SOL']) {
                const s = snap[ticker];
                if (!s) continue;
                const priceEl = document.getElementById(ticker.toLowerCase() + '-price');
                const momEl = document.getElementById(ticker.toLowerCase() + '-momentum');
                if (priceEl) priceEl.textContent = formatPrice(ticker, s.price);
                if (momEl && s.momentum2m) {
                    const m = formatMomentum(s.momentum2m);
                    momEl.textContent = m.text;
                    momEl.className = 'value ' + m.cls;
                }
            }
            
            if (data.stats) {
                document.getElementById('cs-markets').textContent = data.stats.activeMarkets || 0;
                document.getElementById('cs-signals').textContent = data.stats.signals || 0;
                const bEl = document.getElementById('binance-status');
                if (bEl) {
                    const dot = bEl.querySelector('.dot');
                    if (dot) dot.className = 'dot ' + (data.stats.binanceConnected ? 'green' : 'red');
                }
            }
        }

        setInterval(async () => {
            try {
                const [portfolio, opps, crypto] = await Promise.all([
                    fetch('/api/portfolio').then(r => r.json()),
                    fetch('/api/opportunities').then(r => r.json()),
                    fetch('/api/crypto-speed').then(r => r.json()).catch(() => null)
                ]);
                updatePortfolio(portfolio);
                updateOpportunities(opps.opportunities);
                if (crypto) updateCryptoSpeed(crypto);
                document.getElementById('last-update').textContent = 'Last update: ' + new Date().toLocaleTimeString();
            } catch (e) {}
        }, 5000);

        connect();
    </script>
</body>
</html>
