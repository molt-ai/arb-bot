<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arb Bot ‚Äî Live Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, system-ui, 'SF Pro', sans-serif; background: #0a0a0f; color: #e0e0e8; }
        
        .header { 
            background: linear-gradient(135deg, #12121a 0%, #1a1a2e 100%);
            padding: 20px 24px; border-bottom: 1px solid #2a2a3a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.3rem; color: #7c8aff; }
        .header .status { font-size: 0.8rem; color: #4ade80; }
        .header .status.offline { color: #f87171; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; max-width: 1400px; margin: 0 auto; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card {
            background: #12121a; border: 1px solid #2a2a3a; border-radius: 12px;
            padding: 20px; overflow: hidden;
        }
        .card.full { grid-column: 1 / -1; }
        .card h2 { font-size: 0.95rem; color: #8888aa; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Portfolio Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .stat { text-align: center; }
        .stat .value { font-size: 1.6rem; font-weight: 700; color: #fff; }
        .stat .value.green { color: #4ade80; }
        .stat .value.red { color: #f87171; }
        .stat .label { font-size: 0.75rem; color: #6b6b88; margin-top: 4px; }
        
        /* Opportunities Table */
        .opp-list { max-height: 400px; overflow-y: auto; }
        .opp-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            padding: 10px 0; border-bottom: 1px solid #1a1a2a; align-items: center;
            font-size: 0.85rem;
        }
        .opp-row.header { color: #6b6b88; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #2a2a3a; }
        .opp-row .name { color: #c8c8e0; font-weight: 500; }
        .opp-row .spread { font-weight: 700; }
        .opp-row .spread.positive { color: #4ade80; }
        .opp-row .spread.negative { color: #f87171; }
        .opp-row .volume { color: #8888aa; }
        .opp-row .badge {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 4px;
            text-align: center; font-weight: 600;
        }
        .badge.buy { background: #1a3a2a; color: #4ade80; }
        .badge.hold { background: #2a2a1a; color: #facc15; }
        
        /* Trade Log */
        .trade-list { max-height: 350px; overflow-y: auto; }
        .trade-row {
            display: grid; grid-template-columns: 80px 2fr 1fr 1fr 100px;
            padding: 8px 0; border-bottom: 1px solid #1a1a2a;
            font-size: 0.82rem;
        }
        .trade-row.header { color: #6b6b88; font-size: 0.75rem; text-transform: uppercase; }
        .trade-type { font-weight: 700; }
        .trade-type.entry { color: #60a5fa; }
        .trade-type.exit { color: #c084fc; }
        .trade-pnl.positive { color: #4ade80; font-weight: 600; }
        .trade-pnl.negative { color: #f87171; font-weight: 600; }
        
        /* Positions */
        .pos-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            padding: 8px 0; border-bottom: 1px solid #1a1a2a;
            font-size: 0.82rem;
        }
        .pos-row.header { color: #6b6b88; font-size: 0.75rem; text-transform: uppercase; }
        
        /* Bottom bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #12121a; border-top: 1px solid #2a2a3a;
            padding: 8px 24px; display: flex; justify-content: space-between;
            font-size: 0.75rem; color: #6b6b88;
        }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        button {
            background: #2a2a3a; color: #8888aa; border: 1px solid #3a3a4a;
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
        }
        button:hover { background: #3a3a4a; color: #fff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Arb Bot ‚Äî Live Dashboard</h1>
        <div>
            <span class="status" id="ws-status">‚óè Connecting...</span>
            <button onclick="resetPortfolio()" style="margin-left: 12px;">Reset Portfolio</button>
        </div>
    </div>

    <div class="grid">
        <!-- Portfolio Overview -->
        <div class="card full">
            <h2>üìä Portfolio</h2>
            <div class="stats">
                <div class="stat">
                    <div class="value" id="total-value">$20.00</div>
                    <div class="label">Total Value</div>
                </div>
                <div class="stat">
                    <div class="value" id="total-pnl">$0.00</div>
                    <div class="label">Total P&L</div>
                </div>
                <div class="stat">
                    <div class="value" id="total-trades">0</div>
                    <div class="label">Trades</div>
                </div>
                <div class="stat">
                    <div class="value" id="win-rate">0%</div>
                    <div class="label">Win Rate</div>
                </div>
                <div class="stat">
                    <div class="value" id="open-positions">0</div>
                    <div class="label">Open Positions</div>
                </div>
                <div class="stat">
                    <div class="value" id="poly-balance">$10.00</div>
                    <div class="label">Poly Balance</div>
                </div>
                <div class="stat">
                    <div class="value" id="kalshi-balance">$10.00</div>
                    <div class="label">Kalshi Balance</div>
                </div>
                <div class="stat">
                    <div class="value" id="best-trade">‚Äî</div>
                    <div class="label">Best Trade</div>
                </div>
            </div>
        </div>

        <!-- Live Opportunities -->
        <div class="card">
            <h2>üî• Live Opportunities</h2>
            <div class="opp-list">
                <div class="opp-row header">
                    <span>Market</span>
                    <span>Net Spread</span>
                    <span>Poly</span>
                    <span>Kalshi</span>
                    <span>Action</span>
                </div>
                <div id="opportunities">
                    <div style="padding: 20px; text-align: center; color: #6b6b88;">Waiting for data...</div>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="card">
            <h2>üìÇ Open Positions</h2>
            <div class="pos-row header">
                <span>Market</span>
                <span>Side</span>
                <span>Entry Cost</span>
                <span>Expected P&L</span>
                <span>Hold Time</span>
            </div>
            <div id="positions">
                <div style="padding: 20px; text-align: center; color: #6b6b88;">No open positions</div>
            </div>
        </div>

        <!-- Trade Log -->
        <div class="card full">
            <h2>üìã Trade Log</h2>
            <div class="trade-list">
                <div class="trade-row header">
                    <span>Type</span>
                    <span>Market</span>
                    <span>Strategy</span>
                    <span>Cost/Value</span>
                    <span>P&L</span>
                </div>
                <div id="trades">
                    <div style="padding: 20px; text-align: center; color: #6b6b88;">No trades yet ‚Äî bot is scanning...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <span>Paper Trading Mode ‚Äî $1,000 per side simulated</span>
        <span id="last-update">Last update: ‚Äî</span>
    </div>

    <script>
        let ws;
        let reconnectTimer;

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}`);

            ws.onopen = () => {
                document.getElementById('ws-status').textContent = '‚óè Live';
                document.getElementById('ws-status').className = 'status';
            };

            ws.onclose = () => {
                document.getElementById('ws-status').textContent = '‚óè Disconnected';
                document.getElementById('ws-status').className = 'status offline';
                reconnectTimer = setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
        }

        function handleMessage(msg) {
            document.getElementById('last-update').textContent = 
                'Last update: ' + new Date(msg.timestamp).toLocaleTimeString();

            if (msg.type === 'init' || msg.type === 'portfolio') {
                updatePortfolio(msg.data.portfolio || msg.data);
            }
            if (msg.type === 'init' || msg.type === 'opportunities') {
                updateOpportunities(msg.data.opportunities || msg.data);
            }
            if (msg.type === 'trade') {
                // Refresh portfolio after trade
                fetch('/api/portfolio').then(r => r.json()).then(updatePortfolio);
            }
        }

        function updatePortfolio(p) {
            if (!p) return;
            document.getElementById('total-value').textContent = '$' + p.totalValue;
            
            const pnlEl = document.getElementById('total-pnl');
            const pnl = parseFloat(p.totalPnL);
            pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toFixed(2);
            pnlEl.className = 'value ' + (pnl >= 0 ? 'green' : 'red');
            
            document.getElementById('total-trades').textContent = p.totalTrades;
            document.getElementById('win-rate').textContent = p.winRate + '%';
            document.getElementById('open-positions').textContent = p.openPositions;
            document.getElementById('poly-balance').textContent = '$' + p.polyBalance;
            document.getElementById('kalshi-balance').textContent = '$' + p.kalshiBalance;
            document.getElementById('best-trade').textContent = p.bestTrade 
                ? (p.bestTrade.pnl > 0 ? '+' : '') + (p.bestTrade.pnl / 100).toFixed(2) + '¬¢'
                : '‚Äî';

            // Positions
            const posEl = document.getElementById('positions');
            if (p.positions && p.positions.length > 0) {
                posEl.innerHTML = p.positions.map(pos => {
                    const holdMs = Date.now() - new Date(pos.entryTime).getTime();
                    const holdMin = Math.floor(holdMs / 60000);
                    const holdStr = holdMin < 60 ? holdMin + 'm' : Math.floor(holdMin/60) + 'h ' + (holdMin%60) + 'm';
                    return `<div class="pos-row">
                        <span>${pos.name}</span>
                        <span>P:${pos.polySide} K:${pos.kalshiSide}</span>
                        <span>${(pos.totalCost/100).toFixed(2)}¬¢</span>
                        <span class="trade-pnl positive">+${(pos.expectedProfit/100).toFixed(2)}¬¢</span>
                        <span>${holdStr}</span>
                    </div>`;
                }).join('');
            } else {
                posEl.innerHTML = '<div style="padding:20px;text-align:center;color:#6b6b88;">No open positions</div>';
            }

            // Trades
            if (p.recentTrades && p.recentTrades.length > 0) {
                const tradesEl = document.getElementById('trades');
                tradesEl.innerHTML = p.recentTrades.map(t => {
                    const isEntry = t.type === 'ENTRY';
                    const pnl = t.pnl ? (t.pnl/100).toFixed(2) : '‚Äî';
                    const pnlClass = t.pnl > 0 ? 'positive' : t.pnl < 0 ? 'negative' : '';
                    return `<div class="trade-row">
                        <span class="trade-type ${isEntry ? 'entry' : 'exit'}">${t.type}</span>
                        <span>${t.name}</span>
                        <span>P:${t.polySide} K:${t.kalshiSide}</span>
                        <span>${isEntry ? (t.totalCost/100).toFixed(2) + '¬¢' : '‚Äî'}</span>
                        <span class="trade-pnl ${pnlClass}">${isEntry ? '‚Äî' : (t.pnl > 0 ? '+' : '') + pnl + '¬¢'}</span>
                    </div>`;
                }).join('');
            }
        }

        function updateOpportunities(opps) {
            const el = document.getElementById('opportunities');
            if (!opps || opps.length === 0) {
                el.innerHTML = '<div style="padding:20px;text-align:center;color:#6b6b88;">No opportunities found</div>';
                return;
            }
            
            el.innerHTML = opps.slice(0, 20).map(o => {
                const spread = o.netProfit || o.profit || 0;
                const spreadClass = spread > 0 ? 'positive' : 'negative';
                const action = spread > 2 ? 'buy' : 'hold';
                const stratStr = (o.strategy === 1) 
                    ? `Y:${o.polyYes?.toFixed(1)}¬¢` 
                    : `N:${o.polyNo?.toFixed(1)}¬¢`;
                const kalStr = (o.strategy === 1)
                    ? `N:${o.kalshiNo?.toFixed(1)}¬¢`
                    : `Y:${o.kalshiYes?.toFixed(1)}¬¢`;
                    
                return `<div class="opp-row">
                    <span class="name">${o.name || o.outcome || '?'}</span>
                    <span class="spread ${spreadClass}">${spread.toFixed(2)}¬¢</span>
                    <span>${stratStr}</span>
                    <span>${kalStr}</span>
                    <span class="badge ${action}">${action.toUpperCase()}</span>
                </div>`;
            }).join('');
        }

        async function resetPortfolio() {
            if (!confirm('Reset portfolio? This clears all trades and resets balance to $1,000/side.')) return;
            await fetch('/api/reset', { method: 'POST' });
            fetch('/api/portfolio').then(r => r.json()).then(updatePortfolio);
        }

        // Poll for updates every 5s as fallback
        setInterval(async () => {
            try {
                const [portfolio, opps] = await Promise.all([
                    fetch('/api/portfolio').then(r => r.json()),
                    fetch('/api/opportunities').then(r => r.json())
                ]);
                updatePortfolio(portfolio);
                updateOpportunities(opps.opportunities);
                document.getElementById('last-update').textContent = 
                    'Last update: ' + new Date().toLocaleTimeString();
            } catch (e) { /* ignore */ }
        }, 5000);

        connect();
    </script>
</body>
</html>
